<?php

namespace App\Controllers\dashboard;

use App\Controllers\BaseController;

use App\Models\ExploitModel;
use App\Models\ExploitVisitorModel;
use App\Models\ExploitVisitorOTSModel;
use App\Models\UserModel;

class AdminExploit extends BaseController
{
    protected $session;
    protected $db;
    protected $Exploit_Model;
    protected $ExploitVisitor_Model;
    protected $ExploitVisitorOTS_Model;
    protected $User_Model;
    public function __construct()
    {
        $this->session = \Config\Services::session();
        $this->db = \Config\Database::connect();
        $this->Exploit_Model = new ExploitModel();
        $this->ExploitVisitor_Model = new ExploitVisitorModel();
        $this->ExploitVisitorOTS_Model = new ExploitVisitorOTSModel();
        $this->User_Model = new UserModel();
    }
    public function is_pass_same($pass)
    {
        $builder = $this->db->table('user');
        $builder->where('user_password', $pass);
        return !empty($builder->get()->getResult());
    }
    public function delete_file($path, $filename)
    {
        if (!empty($filename))
            unlink($path . $filename);
        return;
    }
    public function konfirmasi_team()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'Konfirmasi',
                'team_list' => $this->Exploit_Model->where('exploit_status', 0)->findAll(),
                'terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
                'belum_terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults(),
                'total_team' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults() + $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
            ];
        return view('landing/pages/dashboard/admin/exploit/konfirmasi_team', $data);
    }
    public function confirmed_team()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'Terkonfirmasi',
                'team_list' => $this->Exploit_Model->where('exploit_status', 1)->findAll(),
                'terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
                'belum_terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults(),
                'total_team' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults() + $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
            ];
        return view('landing/pages/dashboard/admin/exploit/list_team', $data);
    }
    public function verify_konfirmasi_team($id, $status)
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        helper('text');
        $team = $this->Exploit_Model->where('exploit_tim_id', $id)->first();

        if ($status) {
            $password = random_string('special_alnum', 12);

            if ($this->is_pass_same($password)) {
                return redirect()->to('dashboard/admin-exploit/verify-konfirmasi-team/' . $id . '/1');
            } else {
                $data = [
                    'user_lomba'       => 'exploit',
                    'user_tim_nama'    => $team['exploit_tim_nama'],
                    'user_username'    => 'exploit' . '_' . $team['exploit_tim_nama'],
                    'user_password'    => password_hash($password, PASSWORD_DEFAULT)
                ];

                $subject = "[Accepted] Exploit";
                $message = "Halo {$team['exploit_tim_nama']} dari {$team['exploit_asal_institusi']},<br>
                  <br>
                  Terima kasih sudah mendaftar pada event kami, \"Exploit.\"<br>
                  <br>
                  Berikut adalah Username dan Password anda: <br>
                  <br>
                  Username : {$data['user_username']}<br>
                  Password : {$password}<br><br>
                  <br>
                  --<br>
                  Salam Hormat,<br>
                  <br>
                  A Renewal Agents 4.0";
                $email = \Config\Services::email();
                $email->setTo($team['exploit_email']);
                $email->setFrom('arenewalagent@gmail.com', 'ARA 4.0');
                $email->setSubject($subject);
                $email->setMessage($message);

                if ($email->send()) {
                    $data_status = [
                        'exploit_tim_id' => $team['exploit_tim_id'],
                        'exploit_status' => 1
                    ];
                    $this->Exploit_Model->save($data_status);
                    $this->User_Model->save($data);
                    $this->session->setFlashdata('msg', 'Berhasil Menerima Tim: ' . $team['exploit_tim_nama']);
                } else {
                    $this->session->setFlashdata('msg', 'Server Error');
                }
            }
        } else {
            $surat_kontrak_path = 'uploads/exploit/surat_kontrak/';
            $suket_path = 'uploads/exploit/identitas/';

            $subject = "[Rejected] Exploit";
            $message = "Halo {$team['exploit_tim_nama']} dari {$team['exploit_asal_institusi']},<br>
            <br>
            Terima kasih sudah mendaftar pada event kami, \"Exploit.\"<br>
            <br>
            Mohon maaf, persyaratan yang anda kirimkan tidak cukup. Mohon mendaftar kembali di halaman registrasi.<br>
            <br>
            <br>
            --<br>
            Salam Hormat,<br>
            <br>
            A Renewal Agents 4.0";
            $email = \Config\Services::email();
            $email->setTo($team['exploit_email']);
            $email->setFrom('arenewalagent@gmail.com', 'ARA 4.0');
            $email->setSubject($subject);
            $email->setMessage($message);
            if ($email->send()) {
                $this->delete_file($surat_kontrak_path, $team['exploit_surat_kontrak']);

                $this->delete_file($suket_path, $team['exploit_suket_ketua']);

                if ($team['exploit_suket_anggota_1'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_1']);
                }

                if ($team['exploit_suket_anggota_2'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_2']);
                }

                if ($team['exploit_suket_anggota_3'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_3']);
                }

                if ($team['exploit_suket_anggota_4'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_4']);
                }

                $this->Exploit_Model->where('exploit_tim_id', $id)->delete();
                $this->session->setFlashdata('msg', 'Berhasil Menolak Tim: ' . $team['exploit_tim_nama']);
            } else {
                $this->session->setFlashdata('msg', 'Server Error');
            }
        }
        return redirect()->to('dashboard/admin-exploit/konfirmasi-team');
    }

    public function konfirmasi_visitor()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'Konfirmasi',
                'visitors' => $this->ExploitVisitor_Model->where('visitor_status', 0)->findAll(),
                'terkonfirmasi' => $this->ExploitVisitor_Model->where('visitor_status', 1)->countAllResults(),
                'belum_terkonfirmasi' => $this->ExploitVisitor_Model->where('visitor_status', 0)->countAllResults(),
                'total_visitors' => $this->ExploitVisitor_Model->where('visitor_status', 0)->countAllResults() + $this->ExploitVisitor_Model->where('visitor_status', 1)->countAllResults(),
            ];
        return view('landing/pages/dashboard/admin/exploit_visitor/konfirmasi_visitor', $data);
    }

    public function confirmed_visitor()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'List',
                'visitors' => $this->ExploitVisitor_Model->where('visitor_status', 1)->findAll(),
                'terkonfirmasi' => $this->ExploitVisitor_Model->where('visitor_status', 1)->countAllResults(),
                'belum_terkonfirmasi' => $this->ExploitVisitor_Model->where('visitor_status', 0)->countAllResults(),
                'total_visitors' => $this->ExploitVisitor_Model->where('visitor_status', 0)->countAllResults() + $this->ExploitVisitor_Model->where('visitor_status', 1)->countAllResults(),
            ];
        return view('landing/pages/dashboard/admin/exploit_visitor/list_visitor', $data);
    }

    public function verify_konfirmasi_visitor($id, $status)
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }

        // kirim email ke visitor dan update status visitor ke 1
        $visitor = $this->ExploitVisitor_Model->where('visitor_id', $id)->first();
        if ($status == 1) {
            $subject = "[Accepted] Pengunjung ExploIT";
            $message = "Halo {$visitor['visitor_nama']},<br>
            <br>
            Terima kasih sudah mendaftar pada event kami, \"ExploIT.\"<br>
            <br>
            Anda telah terkonfirmasi sebagai pengunjung event ExploIT.<br>
            <br>
            <br>
            --<br>
            Salam Hormat,<br>
            <br>
            A Renewal Agents 4.0";
            $email = \Config\Services::email();
            $email->setTo($visitor['visitor_email']);
            $email->setFrom('arenewalagent@gmail.com', 'ARA 4.0');
            $email->setSubject($subject);
            $email->setMessage($message);
            if ($email->send()) {
                $this->ExploitVisitor_Model->where('visitor_id', $id)->set('visitor_status', 1)->update();
                $this->session->setFlashdata('msg', 'Berhasil Menerima Pengunjung: ' . $visitor['visitor_nama']);
            } else {
                $this->session->setFlashdata('msg', 'Server Error');
            }
        } else {
            $story_invitation_card_path = 'uploads/exploit-visitor/story_invitation_card/';
            $reupload_poster_path = 'uploads/exploit-visitor/reupload_poster/';
            $follow_ig_ara_path = 'uploads/exploit-visitor/follow_ig_ara/';

            $subject = "[Rejected] ExploIT";
            $message = "Halo {$visitor['visitor_nama']},<br>
            <br>
            Terima kasih sudah mendaftar pada event kami, \"ExploIT.\"<br>
            <br>
            Mohon maaf, persyaratan yang anda kirimkan tidak cukup. Mohon mendaftar kembali di halaman registrasi.<br>
            <br>
            <br>
            --<br>
            Salam Hormat,<br>
            <br>
            A Renewal Agents 4.0";
            $email = \Config\Services::email();
            $email->setTo($visitor['visitor_email']);
            $email->setFrom('arenewalagent@gmail.com', 'ARA 4.0');
            $email->setSubject($subject);
            $email->setMessage($message);
            if ($email->send()) {
                $this->delete_file($story_invitation_card_path, $visitor['visitor_story_invitation_card']);
                $this->delete_file($reupload_poster_path, $visitor['visitor_reupload_poster']);
                $this->delete_file($follow_ig_ara_path, $visitor['visitor_follow_ig_ara']);

                $this->ExploitVisitor_Model->where('visitor_id', $id)->delete();
                $this->session->setFlashdata('msg', 'Berhasil Menolak Pengunjung: ' . $visitor['visitor_nama']);
            } else {
                $this->session->setFlashdata('msg', 'Server Error');
            }
        }
        return redirect()->to('dashboard/admin-exploit/konfirmasi-visitor');
    }

    public function register_visitor_ots()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }

        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'Registrasi',
                'validation' => \Config\Services::validation(),
            ];
        return view('landing/pages/dashboard/admin/exploit_visitor/register_visitor_ots', $data);
    }

    public function verify_register_visitor_ots()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }

        $fieldError = 'Field ini harus diisi';

        $validationRules = [
            'nama' => [
                'label' => 'nama',
                'rules' => 'required',
                'errors' => [
                    'required' => $fieldError,
                ]
            ],
            'asal_institusi' => [
                'label' => 'asal_institusi',
                'rules' => 'required',
                'errors' => [
                    'required' => $fieldError,
                ]
            ],
            'whatsapp' => [
                'label' => 'whatsapp',
                'rules' => 'required|is_unique[exploit-visitor-ots.visitor_ots_wa]|numeric',
                'errors' => [
                    'required' => $fieldError,
                    'is_unique' => 'Nomor sudah terdaftar',
                    'numeric' => 'Nomor harus berupa angka'
                ]
            ],
            'email' => [
                'label' => 'email',
                'rules' => 'required|valid_email|is_unique[exploit-visitor-ots.visitor_ots_email]',
                'errors' => [
                    'required' => $fieldError,
                    'valid_email' => 'Email tidak valid',
                    'is_unique' => 'Email sudah terdaftar'
                ]
            ]
        ];

        if (!$this->validate($validationRules)) {
            return redirect()->to('/dashboard/admin-exploit/register/visitor-ots')->withInput();
        }

        $nama = $this->request->getVar('nama');
        $asal_institusi = $this->request->getVar('asal_institusi');
        $whatsapp = $this->request->getVar('whatsapp');
        $email_visitor = $this->request->getVar('email');

        $data = [
            'visitor_ots_nama' => $nama,
            'visitor_ots_email' => $email_visitor,
            'visitor_ots_wa' => $whatsapp,
            'visitor_ots_institusi' => $asal_institusi,
            'visitor_ots_status' => 1
        ];

        $this->ExploitVisitorOTS_Model->save($data);
        $this->session->setFlashdata('msg', 'Registrasi berhasil');
        return redirect()->to('/dashboard/admin-exploit/register/visitor-ots');
    }

    public function list_visitor_ots()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }

        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'List (OTS)',
                'visitors' => $this->ExploitVisitorOTS_Model->where('visitor_ots_status', 1)->findAll()
            ];
        return view('landing/pages/dashboard/admin/exploit_visitor/list_visitor_ots', $data);
    }
}
